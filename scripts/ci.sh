#!/bin/bash

# GPU Genie CI Script
# GitHub Actions„ÅÆCI„ÉØ„Éº„ÇØ„Éï„É≠„Éº„Çí„É≠„Éº„Ç´„É´„ÅßÂÆüË°å„Åô„Çã„Åü„ÇÅ„ÅÆ„Çπ„ÇØ„É™„Éó„Éà

set -e  # „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„ÅüÂ†¥Âêà„Å´„Çπ„ÇØ„É™„Éó„Éà„ÇíÁµÇ‰∫Ü

# Ëâ≤‰ªò„Åç„ÅÆÂá∫ÂäõÁî®
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# „É≠„Ç∞Èñ¢Êï∞
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Ë®≠ÂÆöÂ§âÊï∞
NODE_VERSION="18"
TERRAFORM_VERSION="1.5"

# „Ç®„É©„Éº„Ç´„Ç¶„É≥„Çø„Éº
ERROR_COUNT=0

# „Ç®„É©„Éº„ÇíË®òÈå≤„Åô„ÇãÈñ¢Êï∞
record_error() {
    ERROR_COUNT=$((ERROR_COUNT + 1))
    log_error "$1"
}

# „Éó„É≠„Ç∏„Çß„ÇØ„Éà„É´„Éº„Éà„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅÆÁ¢∫Ë™ç
if [ ! -f "package.json" ] && [ ! -d "frontend" ] && [ ! -d "backend" ]; then
    log_error "„Åì„ÅÆ„Çπ„ÇØ„É™„Éó„Éà„ÅØ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„É´„Éº„Éà„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅßÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
    exit 1
fi

# ÂøÖË¶Å„Å™„ÉÑ„Éº„É´„ÅÆÁ¢∫Ë™ç
check_requirements() {
    log_info "Checking CI requirements..."
    
    # Node.jsÁ¢∫Ë™ç
    if ! command -v node &> /dev/null; then
        record_error "Node.js „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇNode.js „Çí„Ç§„É≥„Çπ„Éà„Éº„É´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
        return 1
    fi
    
    # npmÁ¢∫Ë™ç
    if ! command -v npm &> /dev/null; then
        record_error "npm „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ"
        return 1
    fi
    
    # TerraformÁ¢∫Ë™çÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
    if ! command -v terraform &> /dev/null; then
        log_warning "Terraform „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇTerraform„ÉÅ„Çß„ÉÉ„ÇØ„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ"
    fi
    
    # DockerÁ¢∫Ë™çÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
    if ! command -v docker &> /dev/null; then
        log_warning "Docker „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇDocker„Éì„É´„Éâ„ÉÜ„Çπ„Éà„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ"
    fi
    
    log_success "Requirements check completed"
}

# „Éï„É≠„É≥„Éà„Ç®„É≥„ÉâCI
run_frontend_ci() {
    log_info "=== Running Frontend CI ==="
    
    cd frontend
    
    # ‰æùÂ≠òÈñ¢‰øÇ„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´
    log_info "Installing frontend dependencies..."
    if ! npm ci; then
        record_error "Frontend dependencies installation failed"
        cd ..
        return 1
    fi
    
    # ESLintÂÆüË°å
    log_info "Running ESLint..."
    if ! npm run lint; then
        record_error "ESLint check failed"
    fi
    
    # TypeScript„Çø„Ç§„Éó„ÉÅ„Çß„ÉÉ„ÇØ
    log_info "Checking TypeScript types..."
    if ! npx tsc --noEmit; then
        record_error "TypeScript type check failed"
    fi
    
    # Prettier„ÉÅ„Çß„ÉÉ„ÇØ
    log_info "Running Prettier check..."
    if ! npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css,md}"; then
        record_error "Prettier check failed"
        log_info "Run 'npx prettier --write \"src/**/*.{ts,tsx,js,jsx,json,css,md}\"' to fix formatting"
    fi
    
    # „Éì„É´„Éâ„ÉÜ„Çπ„Éà
    log_info "Building application..."
    export NEXT_PUBLIC_AWS_REGION=us-east-1
    export NEXT_PUBLIC_API_GATEWAY_URL=https://dummy-api.execute-api.us-east-1.amazonaws.com/dev
    export NEXT_PUBLIC_COGNITO_USER_POOL_ID=dummy
    export NEXT_PUBLIC_COGNITO_USER_POOL_CLIENT_ID=dummy
    export NEXT_PUBLIC_COGNITO_IDENTITY_POOL_ID=dummy
    
    if ! npm run build; then
        record_error "Frontend build failed"
    fi
    
    log_success "Frontend CI completed"
    cd ..
}

# „Éê„ÉÉ„ÇØ„Ç®„É≥„ÉâCI
run_backend_ci() {
    log_info "=== Running Backend CI ==="
    
    cd backend/lambda
    
    # ‰æùÂ≠òÈñ¢‰øÇ„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´
    log_info "Installing backend dependencies..."
    if ! npm ci; then
        record_error "Backend dependencies installation failed"
        cd ../..
        return 1
    fi
    
    # ESLintÂÆüË°å
    log_info "Running ESLint..."
    if ! npx eslint "src/**/*.{ts,js}" --max-warnings 0; then
        record_error "ESLint check failed"
    fi
    
    # TypeScript„Éì„É´„ÉâÔºàÂûã„ÉÅ„Çß„ÉÉ„ÇØÂê´„ÇÄÔºâ
    log_info "Building TypeScript..."
    if ! npm run build; then
        record_error "TypeScript build failed"
    fi
    
    # Prettier„ÉÅ„Çß„ÉÉ„ÇØ
    log_info "Running Prettier check..."
    if ! npx prettier --check "src/**/*.{ts,js,json}"; then
        record_error "Prettier check failed"
        log_info "Run 'npx prettier --write \"src/**/*.{ts,js,json}\"' to fix formatting"
    fi
    
    # „ÉÜ„Çπ„ÉàÂÆüË°å
    log_info "Running tests..."
    export NODE_ENV=test
    export AWS_REGION=us-east-1
    export DYNAMODB_ENDPOINT=http://localhost:8000
    export RESERVATIONS_TABLE=gpu-genie-reservations-test
    export USERS_TABLE=gpu-genie-users-test
    export GPU_SERVERS_TABLE=gpu-genie-gpu-servers-test
    
    if ! npm test; then
        record_error "Backend tests failed"
    fi
    
    log_success "Backend CI completed"
    cd ../..
}

# TerraformÊ§úË®º
run_terraform_validation() {
    log_info "=== Running Terraform Validation ==="
    
    if ! command -v terraform &> /dev/null; then
        log_warning "Terraform not found, skipping validation"
        return 0
    fi
    
    cd terraform
    
    # „Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÉÅ„Çß„ÉÉ„ÇØ
    log_info "Checking Terraform format..."
    if ! terraform fmt -check; then
        record_error "Terraform format check failed"
        log_info "Run 'terraform fmt' to fix formatting"
    fi
    
    # ÂàùÊúüÂåñÔºà„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å™„ÅóÔºâ
    log_info "Initializing Terraform..."
    if ! terraform init -backend=false; then
        record_error "Terraform init failed"
        cd ..
        return 1
    fi
    
    # Ê§úË®º
    log_info "Validating Terraform configuration..."
    if ! terraform validate; then
        record_error "Terraform validation failed"
    fi
    
    # tflintÔºàÂà©Áî®ÂèØËÉΩ„Å™Â†¥ÂêàÔºâ
    if command -v tflint &> /dev/null; then
        log_info "Running tflint..."
        if ! tflint --init; then
            log_warning "tflint init failed"
        elif ! tflint; then
            record_error "tflint check failed"
        fi
    else
        log_warning "tflint not found, skipping advanced linting"
    fi
    
    log_success "Terraform validation completed"
    cd ..
}

# „Çª„Ç≠„É•„É™„ÉÜ„Ç£„Çπ„Ç≠„É£„É≥
run_security_scan() {
    log_info "=== Running Security Scan ==="
    
    # Trivy„ÅÆÁ¢∫Ë™ç
    if ! command -v trivy &> /dev/null; then
        log_warning "Trivy not found, attempting to install..."
        
        # Trivy„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´ÔºàLinux/macOSÔºâ
        if [[ "$OSTYPE" == "linux-gnu"* ]]; then
            # Linux
            if command -v apt-get &> /dev/null; then
                sudo apt-get update && sudo apt-get install -y wget apt-transport-https gnupg lsb-release
                wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
                echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
                sudo apt-get update && sudo apt-get install -y trivy
            elif command -v yum &> /dev/null; then
                # Amazon Linux/CentOS/RHEL
                sudo yum install -y wget
                wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_Linux-64bit.rpm
                sudo rpm -ivh trivy_Linux-64bit.rpm
            fi
        elif [[ "$OSTYPE" == "darwin"* ]]; then
            # macOS
            if command -v brew &> /dev/null; then
                brew install trivy
            else
                log_warning "Homebrew not found, please install Trivy manually"
                return 0
            fi
        fi
    fi
    
    if command -v trivy &> /dev/null; then
        log_info "Running Trivy vulnerability scanner..."
        if ! trivy fs --format table --exit-code 0 .; then
            log_warning "Trivy scan completed with warnings/vulnerabilities"
        fi
    else
        log_warning "Trivy installation failed, skipping security scan"
    fi
    
    log_success "Security scan completed"
}

# Docker„Éì„É´„Éâ„ÉÜ„Çπ„Éà
run_docker_build_test() {
    log_info "=== Running Docker Build Test ==="
    
    if ! command -v docker &> /dev/null; then
        log_warning "Docker not found, skipping build test"
        return 0
    fi
    
    # Docker„Éá„Éº„É¢„É≥„ÅÆÁ¢∫Ë™ç
    if ! docker info &> /dev/null; then
        log_warning "Docker daemon not running, skipping build test"
        return 0
    fi
    
    # „Éï„É≠„É≥„Éà„Ç®„É≥„ÉâDocker„Éì„É´„Éâ
    log_info "Building frontend Docker image..."
    if ! docker build -f frontend/Dockerfile.dev -t gpu-genie-frontend:ci-test frontend/; then
        record_error "Frontend Docker build failed"
    fi
    
    # „Éê„ÉÉ„ÇØ„Ç®„É≥„ÉâDocker„Éì„É´„Éâ
    log_info "Building backend Docker image..."
    if ! docker build -f backend/lambda/Dockerfile.dev -t gpu-genie-backend:ci-test backend/lambda/; then
        record_error "Backend Docker build failed"
    fi
    
    # „ÉÜ„Çπ„ÉàÁî®„Ç§„É°„Éº„Ç∏„ÅÆÂâäÈô§
    log_info "Cleaning up test images..."
    docker rmi gpu-genie-frontend:ci-test gpu-genie-backend:ci-test 2>/dev/null || true
    
    log_success "Docker build test completed"
}

# CIÁµêÊûú„ÅÆ„Çµ„Éû„É™„ÉºË°®Á§∫
show_ci_summary() {
    echo ""
    echo "=== CI Summary ==="
    
    if [ $ERROR_COUNT -eq 0 ]; then
        log_success "üéâ All CI checks passed!"
        echo ""
        echo "‚úÖ Frontend CI: PASSED"
        echo "‚úÖ Backend CI: PASSED"
        echo "‚úÖ Terraform Validation: PASSED"
        echo "‚úÖ Security Scan: PASSED"
        echo "‚úÖ Docker Build Test: PASSED"
    else
        log_error "‚ùå CI checks failed with $ERROR_COUNT error(s)"
        echo ""
        echo "Please fix the issues above and run the CI again."
    fi
    
    echo ""
    echo "=== Next Steps ==="
    if [ $ERROR_COUNT -eq 0 ]; then
        echo "1. Your code is ready for pull request/merge"
        echo "2. Consider running deployment: ./scripts/deploy.sh dev"
    else
        echo "1. Fix the reported issues"
        echo "2. Run specific checks:"
        echo "   - Frontend: cd frontend && npm run lint && npm run build"
        echo "   - Backend: cd backend/lambda && npm run lint && npm test"
        echo "   - Terraform: cd terraform && terraform fmt && terraform validate"
        echo "3. Re-run full CI: ./scripts/ci.sh"
    fi
}

# „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÈñ¢Êï∞
cleanup() {
    log_info "Cleaning up temporary files..."
    # ÂøÖË¶Å„Å´Âøú„Åò„Å¶„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂá¶ÁêÜ„ÇíËøΩÂä†
}

# „É°„Ç§„É≥ÂÆüË°åÈñ¢Êï∞
main() {
    # ÈñãÂßãÊôÇÂàª„ÅÆË®òÈå≤
    START_TIME=$(date +%s)
    
    log_info "=== GPU Genie CI Script ==="
    log_info "Timestamp: $(date)"
    echo ""
    
    # ÂêÑ„Çπ„ÉÜ„ÉÉ„Éó„ÅÆÂÆüË°å
    check_requirements
    
    # ‰∏¶ÂàóÂÆüË°åÂèØËÉΩ„Å™„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÈ†ÜÊ¨°ÂÆüË°å
    run_frontend_ci
    run_backend_ci
    run_terraform_validation
    run_security_scan
    run_docker_build_test
    
    # ÁµêÊûú„ÅÆ„Çµ„Éû„É™„ÉºË°®Á§∫
    show_ci_summary
    
    # ÁµÇ‰∫ÜÊôÇÂàª„ÅÆË®àÁÆó
    END_TIME=$(date +%s)
    DURATION=$((END_TIME - START_TIME))
    
    echo ""
    log_info "Total CI execution time: ${DURATION} seconds"
    
    # „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
    cleanup
    
    # ÁµÇ‰∫Ü„Ç≥„Éº„Éâ
    if [ $ERROR_COUNT -eq 0 ]; then
        exit 0
    else
        exit 1
    fi
}

# „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
trap 'log_error "CI execution interrupted!"; cleanup; exit 1' INT TERM

# „Çπ„ÇØ„É™„Éó„Éà„ÅÆÂÆüË°å
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi 